<div class="page-title mb-4">
    <i class="bi bi-receipt"></i> Detalle de Orden #{{.Order.ID}}
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Mesa #{{.Order.TableNum}}</h4>
            <span class="badge {{if eq .Order.Status " completed"}}bg-success{{else if eq .Order.Status "cancelled"
                }}bg-danger{{else}}bg-warning{{end}} px-3 py-2">
                {{if eq .Order.Status "pending"}}Pendiente{{else if eq .Order.Status
                "completed"}}Completada{{else}}Cancelada{{end}}
            </span>
        </div>
    </div>
</div>

<div class="row">
    <!-- Columna izquierda: Detalles de la orden -->
    <div class="col-md-7">
        <div class="macos-card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Productos ordenados</h5>
                <span>Creada: {{formatDate .Order.CreatedAt}} {{formatTime .Order.CreatedAt}}</span>
            </div>
            <div id="order-items">
                <!-- Este div se actualizará vía HTMX -->
                {{if .Order.Items}}
                <ul class="list-group list-group-flush">
                    {{range .Order.Items}}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-light text-dark rounded-pill me-2">{{.Quantity}}x</span>
                                <h6 class="mb-0">{{.Product.Name}}</h6>
                            </div>
                            <p class="mb-0 text-muted small">{{.Product.Description}}</p>
                            {{if .Notes}}
                            <small class="text-primary"><i class="bi bi-info-circle me-1"></i>{{.Notes}}</small>
                            {{end}}
                        </div>
                        <div class="d-flex flex-column align-items-end">
                            <span class="mb-2">${{printf "%.2f" (multiply .Product.Price .Quantity)}}</span>
                            {{if eq $.Order.Status "pending"}}
                            <button class="btn btn-sm btn-outline-danger" hx-delete="/order/{{$.Order.ID}}/item/{{.ID}}"
                                hx-target="#order-items" hx-confirm="¿Eliminar este producto de la orden?">
                                <i class="bi bi-trash"></i>
                            </button>
                            {{end}}
                        </div>
                    </li>
                    {{end}}
                </ul>
                <div class="p-3 text-end">
                    <h5 class="mb-0">Total: ${{printf "%.2f" .Order.Total}}</h5>
                </div>
                {{else}}
                <div class="p-4 text-center">
                    <i class="bi bi-cart4 fs-1 text-muted mb-3"></i>
                    <h5>No hay productos en esta orden aún</h5>
                    <p class="text-muted">Añade productos utilizando el formulario a continuación</p>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Botones de acción para la orden -->
        {{if eq .Order.Status "pending"}}
        <div class="d-flex gap-2 mb-4">
            <button class="btn macos-btn macos-btn-primary flex-grow-1" hx-post="/order/{{.Order.ID}}/complete"
                hx-confirm="¿Completar esta orden?" hx-redirect="/orders">
                <i class="bi bi-check-circle me-2"></i> Completar Orden
            </button>
            <button class="btn btn-outline-danger flex-grow-1" hx-delete="/order/{{.Order.ID}}"
                hx-confirm="¿Estás seguro de cancelar esta orden?" hx-redirect="/orders">
                <i class="bi bi-x-circle me-2"></i> Cancelar Orden
            </button>
        </div>
        {{else}}
        <div class="d-flex gap-2 mb-4">
            <button class="btn macos-btn flex-grow-1" hx-post="/order/{{.Order.ID}}/print" hx-swap="none">
                <i class="bi bi-printer me-2"></i> Imprimir
            </button>
            <button class="btn btn-outline-secondary flex-grow-1" hx-post="/order/{{.Order.ID}}/duplicate"
                hx-redirect="/orders">
                <i class="bi bi-files me-2"></i> Duplicar
            </button>
        </div>
        {{end}}
    </div>

    <!-- Columna derecha -->
    {{if eq .Order.Status "pending"}}
    <div class="col-md-5">
        <div class="macos-card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Agregar Productos</h5>
            </div>
            <div class="card-body">
                <form hx-post="/order/{{.Order.ID}}/add-item" hx-target="#order-items">
                    <div class="mb-3">
                        <label class="form-label">Categoría</label>
                        <select id="category-select" class="form-select">
                            <option value="all" selected>Todas las categorías</option>
                            {{range .Categories}}
                            <option value="{{.}}">{{.}}</option>
                            {{end}}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Producto</label>
                        <select name="product_id" class="form-select" required>
                            <option value="">Seleccione un producto</option>
                            {{range $category, $products := .ProductsByCategory}}
                            {{range $products}}
                            <option value="{{.ID}}" data-category="{{$category}}" data-price="{{.Price}}">
                                {{.Name}} - ${{printf "%.2f" .Price}}
                            </option>
                            {{end}}
                            {{end}}
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Cantidad</label>
                                <input type="number" name="quantity" class="form-control" value="1" min="1" required>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Notas</label>
                                <input type="text" name="notes" class="form-control"
                                    placeholder="Instrucciones especiales">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn macos-btn macos-btn-primary w-100">
                        <i class="bi bi-plus-circle me-1"></i> Añadir a la Orden
                    </button>
                </form>
            </div>
        </div>
    </div>
    {{else}}
    <div class="col-md-5">
        <div class="macos-card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Información</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Estado:</strong>
                    <span class="badge {{if eq .Order.Status " completed"}}bg-success{{else}}bg-danger{{end}} ms-2">
                        {{if eq .Order.Status "completed"}}Completada{{else}}Cancelada{{end}}
                    </span>
                </div>
                <div class="mb-3">
                    <strong>Fecha de creación:</strong>
                    <span class="text-muted ms-2">{{formatDate .Order.CreatedAt}}</span>
                </div>
                <div class="mb-3">
                    <strong>Hora:</strong>
                    <span class="text-muted ms-2">{{formatTime .Order.CreatedAt}}</span>
                </div>
                <div class="mb-3">
                    <strong>Total:</strong>
                    <span class="text-primary fw-bold ms-2">${{printf "%.2f" .Order.Total}}</span>
                </div>
                {{if .Order.Notes}}
                <div class="mb-3">
                    <strong>Notas:</strong>
                    <p class="text-muted mt-1">{{.Order.Notes}}</p>
                </div>
                {{end}}
                <a href="/orders" class="btn macos-btn w-100">
                    <i class="bi bi-arrow-left me-1"></i> Volver a Órdenes
                </a>
            </div>
        </div>
    </div>
    {{end}}
</div>

<script>
    // Filtrar productos por categoría
    document.getElementById('category-select')?.addEventListener('change', function () {
        const category = this.value;
        const productSelect = document.querySelector('select[name="product_id"]');
        const options = productSelect.querySelectorAll('option');

        options.forEach(option => {
            if (category === 'all' || option.dataset.category === category) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });
    });
</script>